# 文件上传漏洞

文件上传漏洞是指用户上传了一个可执行的脚本文件，并通过此脚本文件获得了执行服务器端命令的能力。这种攻击方式是最为直接和有效的，“文件上传” 本身没有问题，有问题的是文件上传后，服务器怎么处理、解释文件。主要有以下类型：

* 服务器的错误配置
* 开源编辑器的漏洞
* 本地上传限制不严格被绕过
* 服务器端过滤不严格被绕过

## 1、轻量级的检测绕过

### 	1.1、客户端检测绕过

如图，只在客户端前端对文件格式是否为满足条件的 png、bmp、gif、jpg 进行了校验。

![image-20231220224311413](../../../Git/NOTE/渗透学习笔记/SQL注入/image-20231220224311413.png)

将.php 后缀改为符合前段检测的.jpg，抓包修改后缀名为 php 即可绕过前端校验，如果是 JS 校验也可以选择禁用浏览器 JS 绕过。

### 	1.2、服务端 MIME 绕过

MIME(Multipurpose Internet Mail Extensions)多用途互联网邮件扩展类型。是设定某种扩展名的文件用一种应用程序来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。

MIME 检测的是数据包 content-type 字段，将 Content-TYpe 修改为符合 MIME 检测的。常见的图片格式的 MIME 类型有以下几种类型：

```css
text/plain （纯文本） 
text/html （HTML文档） 
text/javascript （js代码） 
application/xhtml+xml （XHTML文档） 
image/gif （GIF图像） 
image/jpeg （JPEG图像） 
image/png （PNG图像） 
video/mpeg （MPEG动画） 
application/octet-stream （二进制数据） 
application/pdf （PDF文档）
```

### 	1.3、服务端目录检测绕过

在文件上传时，有的程序允许用户将文件放到指定的目录中，如果指定目录存在就将文件写入目录，不存在则先建立目录，然后写入。

.......

## 2、服务端拓展名检测绕过

- 黑名单
   列出不允许上传的文件类型，任何不在黑名单中的文件都可以上传。这种方法侧重于禁止已知的危险文件类型。
- 白名单
   列出允许上传的文件类型，只有在白名单中的文件才能上传。这种方法侧重于只允许已知的安全文件类型。

### 2.1、黑名单

####  文件名大小写绕过

​		upload-labs第六关，将拓展名修改为大小写结合格式，Windows下对大小写不敏感可使用该方法，Linux则对大小写敏感。

```css
pHp、Asp、Jsp、aSpX
```

####  特殊文件名绕过

##### 	其他偏门后缀绕过

​	**upload-labs第三关**

* PHP文件的其他后缀

  ```css
  php1、php2、php3、php4、php5、phtml、pht
  ```

* ASP文件的其他后缀

  ```css
  asa、cdx、cer
  ```

* JSP文件的其他后缀

  ```css
  jspx、jspf
  ```

* aspx文件的其他后缀

  ```css
  ashx、asmx、asax、ascx
  ```

##### 	空格和点绕过

​	**upload-labs第五、七、八关**

​	在**Windows**下有一个特性就是如果文件后缀以点'.'或者空格' '结尾的后缀名时，系统在保存文件时会自动去除点和空格。但要注意 **Unix/Linux** 系统==没有==这个特性。

##### 	多写绕过

​	**upload-labs第十一关**

​	检测php及php1、phtml、pht等后缀，可使用双写为pphphp或多写pphphphppphp等。

##### 	::$DATA绕过

​	**upload-labs第九关**

只能在PHP+Windows环境下生效，文件后缀后添加流文件标识符`::$DATA`，在**Windows**下会将`::$DATA`后的数据作为文件流处理，不会检测后缀名，且保持`::$DATA`之前的文件名

#### .htaccess文件（解析漏洞）

.htaccess文件(或者"分布式配置文件") ,全称是Hypertext Access(超文本入口)。提供了针对目录改变配置的方法，即，在一个特定的文档目录中放置一个包含一个或多个指令的文件，以作用于此目录及其所有子目录。作为用户，所能使用的命令受到限制。管理员可以通过Apache的AllowOverride指令来设置。
		如果服务器对文件名控制不够严格，通过 move uploaded_file 函数把自己写的 .htaccess 文件覆盖掉服务器上的这样就可以解析定义名单了.htaccess文件内容:

```htaccess
<FilesMatch "haha”>
SetHandler application/x-httpd-php  #在当前目录下，如果匹配到evil.gif文件，则被解析成PHP代码执行
</FilesMatch>
```

通过.htaccess文件调用php解释器去解析一个文件名中只要包含 “haha”这个字符串的任意文件，无论你文件名是什么样子，只要包含”haha”这个字符串，都可以被以php的方式来解析。

### 2.2、白名单

##### 	%00截断绕过

**upload-labs第十二关**

文件名后缀有一个%00字节，可以截断某些函数对文件名的判断。在许多语言函数中，处理字符串的函数中0x00被认为是==终止符==。

例如: 网站上传函数处理xxx.asp%00.jpg时，首先后缀名是合法的jpg格式，可以上传，在保存文件时，遇到%00字符丢弃后面的 .jpg，文件后缀最终保存的后缀名为xxx.asp

##### 	%00 hex截断绕过

**upload-labs第十三关**

如下图所示，save_path参数通过POST方式传递，还是利用00截断，因为POST不会像GET对%00进行自动解码，所以需要在二进制中进行修改。

.....

#### 解析/包含漏洞绕过

这类绕过直接配合上传一个代码注入过的白名单文件即可，再利用解析/包含漏洞。

解析漏洞指文件在某种格式下，会被执行为该脚本语言的文件。通常发生在如**IIS、Apache、Nginx、Tomcat**等Web容器中。

包含漏洞指程序开发人员一般会把重复使用的函数写到单个文件中，需要使用某个函数时直接调用此文件，而无需再次编写，这中文件调用的过程一般被称为文件包含。程序开发人员一般希望代码更灵活，所以将被包含的文件设置为变量，用来进行动态调用，
 但正是由于这种灵活性，从而导致客户端可以调用一个恶意文件，造成文件包含漏洞。

## 3、文件内容检测绕过

**upload-labs靶场第14、15、16关**

###  3.1、图片马：

* 参数/b指定以二进制格式复制、合并文件; 用于图像类/声音类文件

* 参数/a指定以ASCII格式复制、合并文件。用于txt等文档类文件

```css
Windows：copy 一张图片.png/b+一句话木马.php/a 生成图片名称.png
Linux：cat 一张图片.jpg 木马.php > 生成图片名称
```

### 3.2、文件头检测

在每一个文件（包括图片，视频或其他的非ASCII文件）的开头（十六进制表示）实际上都有一片区域来显示这个文件的实际用法，这就是文件头标志。我们可以通过16进制编辑器打开文件，**添加服务器允许的文件头**以绕过检测。

#### 文件幻术检测绕过

图像相关的信息检测常用getimagesize( )函数。每种类型的图片内容最开头会有一个标志性的头部，这个头部被称为文件幻术。常用图片类型有以下几类：

* 绕过**jpg**文件幻术检测要在文件开头写上下图的值：

![image-20231229094245536](../../../Git/NOTE/渗透学习笔记/SQL注入/image-20231229094245536.png)

​	                                                                            Value = **FF D8 FF E0 00 10 4A 46 49 46**

* 绕过**png**文件幻术检测要在文件开头写上下图的值

![image-20231229094255299](../../../Git/NOTE/渗透学习笔记/SQL注入/image-20231229094255299.png)

​																						Value = **89 50 4E 47**

* 绕过**gif**文件幻术检测要在文件开头写上下图的值：

![image-20231229094303965](../../../Git/NOTE/渗透学习笔记/SQL注入/image-20231229094303965.png)

​                                                                                    Value = **47 49 46 38 39 61**


#### 文件上传功能的业务逻辑

文件上传功能的作用是将==本地文件上传至服务器==上保存，当我们找到上传的入口，上传文件后可能会回显文件上传的路径，可以根据回显的文件上传路径进行访问，那么可以在浏览器中访问到服务器上的这个文件。

## 4、Apache解析漏洞

## 5、测试思路

#### 5.1、寻找上传点

网站前台的上传点一般有头像上传、附件上传、证件认证上传。如果通过SQL注入或者其它一些技术手段得到网站后台权限，一般在网站更新页面的地方会存在上传点。也可以通过敏感目录或文件描工具扫到一些开源编辑器的测试上传页面等等。

#### 5.2、测试上传点

找到上传点后，可以先上传一张正常的图片测试该上传点是否可正常使用，上传点不可用的情况是不少的。

#### 5.2.1、测试是否有后缀、内容校验

上传一张正常图片，抓包修改文件后缀名为对应网站脚本语言。

该操作可绕过前端检测、MIME检测、文件内容检测。可以检测出网站是否对上传进行了文件后缀名的监测。

如果成功上传则说明没有对文件后缀名进行检测，可以进一步上传图片马，抓包修改文件后缀名为对应网站脚本语言即可获取webshell。

如果上传失败表示对文件名后缀进行了检测，需要进一步判断是黑名单检测还是白名单检测。

#### 5.2.2、判断黑白名单

上传一张正常的图片，随意修改下后缀，如1.jpgasdasdasdas，这些后缀即不在黑名单也不在白名单内。

如果上传成功则表示是黑名单检测，如果上传失败则表示是白名单检测。

#### 5.2.3、黑名单检测绕过

手段有如下几种

```css
文件名大小写绕过
特殊文件名绕过
0x00截断绕过
.htaccess文件攻击
php文件包含漏洞
解析漏洞
```

#### 4、白名单检测绕过

手段有如下几种

```css
0x00截断绕过
文件包含漏洞
解析漏洞
```

## 6、Upload-labs

#### 	Pass-01

##### 				js 绕过

有两种方法可以绕过客户端 **JavaScript** 的检测。

* 浏览器插件禁用 js
* 先把文件后缀改成可以上传的，然后抓包修改后缀

#### Pass-02

##### 		服务端 MIME 绕过

MIME 检测的是数据包 **content-type** 字段。常见的图片格式的 MIME 类型有以下几种类型：

* PNG 图像：image/png

* GIF 图形： image/gif

* JPG 图形：image/jpeg

#### Pass-03

##### 	文件后缀绕过（Apache 解析漏洞：apache 1.x  apache 2.2.x）

虽然服务器端代码中限制了某些后缀的文件上传，但有些版本的 Apache 允许解析其他文件，Apache 是==从右向左==解析文件后缀，如`test.php.a.b`的“`.a`”和“`.b`”这两种后缀是`apache`不可识别解析，`apache`就会把`test.php.a.b`解析成`test.php`。

因此上传的文件名类似 **1.php.xxxx** 或 **1.phtml**。

#### Pass-04

##### 	.htaccess 绕过

.htaccess 文件代码可编写如下，这个.htaccess 的意思就是把所有名字里面含有 muma.png（名字随便取）的文件当成 php 脚本来执行：

```css
<FilesMatch "muma.png">
  SetHandler application/x-httpd-php
</FilesMatch>
```

.htaccess 的另一种写法，这里代码的意思可以让 .jpg 后缀名文件格式的文件名以 php 格式解析：

```css
<FilesMatch "muma.png">
  AddType application/x-httpd-php .png
</FilesMatch>
```

通过 BP 上传.htaccess 文件后，就可以上传包含木马的.png 文件。

#### Pass-05

#### Pass-06

#### Pass-07

#### Pass-08

#### Pass-09

#### Pass-10

#### Pass-11

#### Pass-12

#### Pass-13

#### Pass-14

#### Pass-15

#### Pass-16

#### Pass-17

#### Pass-18

#### Pass-19

#### Pass-20

#### Pass-21
